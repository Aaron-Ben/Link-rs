# 网络传输层（L4）开发文档
## 项目概述
本项目是基于 Rust 自研的高性能网络传输层，核心目标是在不可靠网络之上，为上层提供“可靠、可控、高性能”的数据管道。基础版聚焦核心传输能力实现，增强版针对在线会议（如飞书会议）场景优化弱网抗性、实时性和多流协同，支持多路复用、弱网恢复、网络切换不中断等关键能力。

## 一、基础部分：核心功能实现（MVP版）
### 1. 自定义帧协议
- **解决问题**：底层 UDP/TCP 为字节流，需明确消息边界，避免粘包/拆包与数据篡改。
- **实现方案**：帧格式（大端字节序）：`长度字段（4字节）+ 流ID（2字节）+ 帧类型（1字节）+ 序列号（4字节）+ 数据体 + CRC校验（2字节）`；接收方先读长度字段，再按长度读取完整帧，通过 CRC 校验完整性。
- **设计原因**：长度字段直接解决粘包/拆包问题；流ID、帧类型为后续多路复用和可靠性机制预留扩展；CRC校验低成本保障数据完整性。
- **参考项目**：quinn 的帧协议设计

### 2. 连接管理基础实现
- **解决问题**：建立端到端逻辑通道，同步通信双方状态（初始序列号、窗口大小），避免连接混乱。
- **实现方案**：1-RTT 握手（客户端发 SYN 帧→服务端回 SYN-ACK 帧→客户端发 ACK 帧）；用 IP+端口临时标识连接；通过 FIN 帧协商断开，确认后释放资源。
- **设计原因**：1-RTT 握手平衡可靠性与实时性，比 TCP 三次握手延迟更低；简化连接标识降低初期实现复杂度，优先保障连接建立核心能力。
- **参考项目**：QUIC 的 1-RTT 握手流程（quinn 库）

### 3. 基础可靠性保障
- **解决问题**：应对 IP 层丢包、乱序，确保数据“不丢、不重、按序”到达。
- **实现方案**：序列号+ACK 机制（接收方回复携带最大连续序列号的 ACK 帧）；超时重传（维护未确认帧队列，超时未收 ACK 则重传）；接收方去重（维护已接收序列号集合）。
- **设计原因**：序列号+ACK 是可靠性基础，让发送方精准感知丢包；RTT 补偿的超时策略避免无效重传，减少网络冗余。
- **参考项目**：TCP 的 ARQ 机制、QUIC 的 reliable frame ack ranges（quinn 实现）

### 4. 简单流量控制
- **解决问题**：避免发送方速率过快导致接收方缓冲区溢出，或单流占用所有资源。
- **实现方案**：滑动窗口机制（接收方在 ACK 帧中携带可用缓冲区大小，发送方仅发窗口内帧）；动态窗口调整（按缓冲区使用率实时更新窗口值）。
- **设计原因**：滑动窗口直接关联接收方处理能力，从根源避免盲目发送；动态调整适配会议场景中接收方 CPU 负载波动。
- **参考项目**：TCP 滑动窗口机制、QUIC 流级窗口基础逻辑

### 5. 多路复用基础实现
- **解决问题**：支持单连接承载多业务流（音频、视频、控制消息），减少连接建立开销。
- **实现方案**：流 ID 标识（帧协议中用流 ID 区分不同流）；独立缓冲区（每个流维护专属发送/接收缓冲区，避免数据混合）。
- **设计原因**：单连接多流减少握手延迟和系统资源占用；流 ID 设计简单易实现，为后续优先级调度预留扩展空间。
- **参考项目**：yamux（libp2p 多路复用库）的流管理逻辑

### 6. 基础拥塞控制
- **解决问题**：避免发送方速率超过网络承载能力，导致批量丢包和网络雪崩。
- **实现方案**：基于丢包的拥塞感知（丢包时发送窗口减半）；慢启动（初始窗口设为 2 个 MTU，每收一批 ACK 窗口加 1）。
- **设计原因**：丢包是拥塞的直观信号，适合 MVP 版简化实现；慢启动避免刚连接就占满带宽，降低网络冲击。
- **参考项目**：TCP Reno 基础拥塞控制、quinn 拥塞控制简化版

## 二、在线会议场景增强部分（适配飞书会议等实时场景）
### 1. 弱网抗丢包优化
- **解决问题**：弱网环境（30% 丢包）导致音视频卡顿、花屏。
- **实现方案**：前向纠错（FEC）（发送音视频帧时附加 10-20% 冗余数据）；快速重传（收到 3 个重复 ACK 立即重传，无需等超时）。
- **设计原因**：FEC 用冗余换取无重传延迟，适配实时会议场景；快速重传比超时重传快 1-2 个 RTT，解决低丢包场景延迟问题。
- **参考项目**：WebRTC 的 FEC 实现（webrtc-rs 库）、mediasoup 的 NACK/FEC 策略

### 2. 网络切换不中断（连接迁移）
- **解决问题**：用户切换网络（Wi-Fi 切 5G）导致连接中断，需重新入会。
- **实现方案**：连接 ID 替代 IP+端口（为每个连接分配唯一 conn_id，帧协议携带 conn_id）；地址更新机制（客户端切换网络后发送 ADDRESS_UPDATE 帧，服务端更新映射）。
- **设计原因**：连接 ID 解耦连接与底层网络地址，支持 IP/端口变化；地址更新帧确保服务端实时感知网络变化，实现无缝切换。
- **参考项目**：QUIC 的连接迁移机制（quinn 库）、飞书会议网络切换方案

### 3. 多流优先级调度
- **解决问题**：多流争抢带宽，导致关键流（音频）卡顿。
- **实现方案**：流优先级划分（音频流>控制流>视频流>文件流）；发送队列调度（按优先级排序帧，拥塞时高优先级帧插队）。
- **设计原因**：音频是会议核心体验，高优先级保障“能听优先”；优先级调度避免非关键流（如文件共享）影响核心业务。
- **参考项目**：livekit 的流优先级调度、QUIC 的流优先级机制

### 4. 延迟抖动优化
- **解决问题**：RTT 波动导致音视频卡顿、不同步。
- **实现方案**：Jitter Buffer（抖动缓冲区）（缓存 200-500ms 音视频帧，固定间隔播放）；动态帧丢弃（缓冲区堆积超 1s 时，优先丢低优先级视频帧）。
- **设计原因**：Jitter Buffer 用预缓存平滑抖动，是实时音视频标准方案；动态丢帧避免延迟累积，平衡流畅度与实时性。
- **参考项目**：WebRTC 的 Jitter Buffer 实现、ion-sfu 的帧丢弃策略

### 5. 智能拥塞控制（BBR 算法）
- **解决问题**：弱网/跨国会议中，基于丢包的拥塞控制误判，导致速率过低。
- **实现方案**：基于带宽和延迟的拥塞感知（通过 RTT 和发送数据量估算链路带宽）；pacing 发送（按估算带宽匀速发送，避免突发流量）。
- **设计原因**：BBR 算法在弱网/长距离场景表现更优，提升带宽利用率；匀速发送减少网络抖动，适配音视频平稳传输需求。
- **参考项目**：Google BBR 算法、quinn 的 BBR 拥塞控制实现

## 三、核心参考项目汇总
| 功能领域         | 核心参考项目                | 参考价值                          |
|------------------|-----------------------------|-----------------------------------|
| 基础传输层框架   | quinn（Rust QUIC 实现）     | 帧协议、连接管理、拥塞控制工业级实现 |
| 多路复用         | yamux（libp2p）             | 单连接多流高效管理逻辑            |
| 实时音视频传输   | mediasoup、livekit、ion-sfu  | 弱网优化、流调度、QoS 策略         |
| 可靠性与 FEC     | webrtc-rs                   | 实时场景丢包恢复机制              |
| 拥塞控制         | Google BBR、quinn 拥塞模块   | 带宽估算与速率调整逻辑            |

